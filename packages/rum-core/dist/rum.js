var U="0.1.0";function he(){let e=[],n=new Set;return{use(t){if(!t||!t.name){try{console.warn?.("[RUM] invalid plugin ignored:",t)}catch{}return}if(n.has(t.name)){try{console.warn?.(`[RUM] plugin "${t.name}" already registered, skip`)}catch{}return}e.push(t),n.add(t.name)},setupAll(t,r){for(let o of e)try{o.setup(t,r)}catch(a){try{console.error?.(`[RUM] plugin "${o.name}" setup failed:`,a)}catch{}}},teardownAll(){for(let t=e.length-1;t>=0;t--){let r=e[t];try{r.teardown?.()}catch(o){try{console.error?.(`[RUM] plugin "${r.name}" teardown failed:`,o)}catch{}}}e.length=0,n.clear()},has(t){return n.has(t)},list(){return e.map(t=>t.name)}}}function ve(e){return{appId:e.appId,release:e.release,env:e.env??"prod",sessionId:O(),pageId:O(),sampleRate:e.sampleRate??1,allowDomains:new Set(e.allowDomains??[]),allowParams:new Set(e.allowUrlParams??[])}}function Re(e){e.pageId=O()}function O(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}var P="__RUM_OFFLINE_Q__";function we(e){let n=[],t=null,r=[],o=l=>{for(let c of r)try{c(l)}catch{}};try{let l=localStorage.getItem(P);if(l){let c=JSON.parse(l);Array.isArray(c)&&n.push(...c),localStorage.removeItem(P)}}catch{}function a(){t||(t=window.setTimeout(()=>i(),2e3))}function s(l){let c={t:Date.now(),...l};n.push(c),o(c),n.length>=20?i(!0):a()}async function u(l,c=!1){let{endpoint:d,appId:p,release:f}=e;if(!d)return!0;let g=JSON.stringify({appId:p,release:f,sentAt:Date.now(),events:l});try{if(navigator.sendBeacon&&navigator.sendBeacon(d,new Blob([g],{type:"application/json"})))return!0}catch{}try{if((await fetch(d,{method:"POST",headers:{"content-type":"application/json"},body:g,keepalive:c})).ok)return!0}catch{}try{let m=new Image;return m.src=`${d}?d=${encodeURIComponent(g)}`,await new Promise(x=>{let h=()=>{m.onload=m.onerror=null,x()};m.onload=h,m.onerror=h,setTimeout(h,1200)}),!0}catch{}return!1}async function i(l=!1){if(!n.length){t&&(clearTimeout(t),t=null);return}let c=n.splice(0,n.length);if(t&&(clearTimeout(t),t=null),!await u(c,l))try{let p=localStorage.getItem(P),f=p?JSON.parse(p):[];localStorage.setItem(P,JSON.stringify([...f||[],...c].slice(-2e3)))}catch{}}return{track:s,flush:i,__subscribe(l){return r.push(l),()=>{let c=r.indexOf(l);c>=0&&r.splice(c,1)}}}}var H,D,F,N={name:"error",setup(e,n){n.track({type:"__plugin_loaded",plugin:"error"});let t=new Map,r=s=>{let i=s.target;if(i&&(i.src||i.href)){let m=(i.tagName||"").toUpperCase(),x=i.src||i.href,h=Te(x,e.allowParams);if(b(t,Me(m,h)))return;n.track({type:"res-error",tag:m,url:h,pageId:e.pageId});return}let l=s,c=y(l.filename,300),d=y(l.message,500),p=l.lineno??0,f=l.colno??0,g=y(l.error?.stack||"",2e3);b(t,Ce(d,c,p,f,g))||n.track({type:"js-error",message:d,filename:c,lineno:p,colno:f,stack:g,pageId:e.pageId})},o=s=>{let u=Le(s.reason),i=Ae(s.reason);b(t,xe(u,i))||n.track({type:"promise-reject",reason:u,stack:i,pageId:e.pageId})},a=s=>{try{let u={type:"csp-violation",effectiveDirective:String(s.effectiveDirective||""),violatedDirective:String(s.violatedDirective||""),blockedURI:y(s.blockedURI||"",500),sourceFile:y(s.sourceFile||"",300),lineNumber:s.lineNumber??0,columnNumber:s.columnNumber??0,pageId:e.pageId},i=E(Oe(u)).toString(36);if(b(t,i))return;n.track(u)}catch{}};addEventListener("error",r,!0),addEventListener("unhandledrejection",o),typeof document<"u"&&document.addEventListener("securitypolicyviolation",a),H=()=>removeEventListener("error",r,!0),D=()=>removeEventListener("unhandledrejection",o),F=()=>document.removeEventListener?.("securitypolicyviolation",a)},teardown(){H?.(),H=void 0,D?.(),D=void 0,F?.(),F=void 0}};function Te(e,n){try{let t=new URL(e,location.href);if(n&&n.size>0){let r=new URLSearchParams;t.searchParams.forEach((o,a)=>{n.has(a)&&r.set(a,o)}),t.search=r.toString()}else t.search="";return t.hash="",t.toString()}catch{return String(e||"")}}function y(e,n=1e3){if(e==null)return"";let t=typeof e=="string"?e:String(e);return t.length>n?t.slice(0,n):t}function Le(e){if(e==null)return"";if(typeof e=="string")return y(e,500);if(e&&(e.stack||e.message)){let n=e.message?`${e.name?e.name+": ":""}${e.message}`:"";return y(n||String(e),500)}try{return y(JSON.stringify(e),500)}catch{return y(e,500)}}function Ae(e){let n=e?.stack||"";return y(n,2e3)}function b(e,n){let t=Date.now(),r=e.get(n)||0;if(t-r<1e4)return!0;if(e.set(n,t),e.size>200){let o=t-2e4;for(let[a,s]of e)s<o&&e.delete(a)}return!1}function Ce(e,n,t,r,o){let a=`${e}|${Ue(n)}|${t}|${r}|${Ie(o,5)}`;return E(a).toString(36)}function Me(e,n){return E(`${e}|${n}`).toString(36)}function xe(e,n){return E(`${e}|${Ie(n,5)}`).toString(36)}function Ue(e){try{return e.split("?")[0].split("#")[0].split("/").pop()||e}catch{return e}}function Ie(e,n=5){return(e||"").split(`
`).slice(0,n).join(`
`)}function E(e){let n=5381,t=e.length;for(;t;)n=n*33^e.charCodeAt(--t);return n>>>0}function Oe(e){try{return JSON.stringify(e,Object.keys(e).sort())}catch{return String(e)}}var q,X,W={name:"net",setup(e,n){if(n.track({type:"__plugin_loaded",plugin:"net"}),typeof window.fetch=="function"){let r=window.fetch.bind(window);window.fetch=(o,a)=>{let s=He(o,a);if(!Se(s.url,e.allowDomains))return r(o,a);let u=Pe(),i=v(),l=o,c=a?{...a}:void 0;try{let d=De(o instanceof Request?o.headers:void 0,a?.headers);d.set("x-trace-id",u),o instanceof Request?l=new Request(o,{headers:d}):c={...c||{},headers:d}}catch{}return r(l,c).then(d=>{let p=v()-i;return n.track({type:"api",url:z(s.url,e.allowParams),method:s.method,status:d.status,ok:d.ok,dur:p,traceId:u,pageId:e.pageId}),d}).catch(d=>{let p=v()-i;throw n.track({type:"api",url:z(s.url,e.allowParams),method:s.method,status:0,error:String(d?.message||d),dur:p,traceId:u,pageId:e.pageId}),d})},q=()=>{window.fetch=r}}let t=window.XMLHttpRequest;if(t&&t.prototype){let r=t.prototype.open,o=t.prototype.send,a=t.prototype.setRequestHeader;t.prototype.open=function(s,u,i,l,c){return this.__rum_meta={method:(s||"GET").toUpperCase(),url:String(u)},r.call(this,s,u,i,l,c)},t.prototype.setRequestHeader=function(s,u){return this.__rum_hdrs||(this.__rum_hdrs=new Headers),this.__rum_hdrs.set(s,u),a.call(this,s,u)},t.prototype.send=function(s){let u=this.__rum_meta||{method:"GET",url:""},i=String(u.url||""),l=String(u.method||"GET").toUpperCase();if(!Se(i,e.allowDomains))return o.call(this,s);let c=Pe();try{(this.__rum_hdrs||new Headers).has("x-trace-id")||this.setRequestHeader("x-trace-id",c)}catch{}let d=v(),p=f=>{let g=v()-d,m=(this.status===1223?204:this.status)??0;n.track({type:"api",url:z(i,e.allowParams),method:l,status:m||0,dur:g,traceId:c,pageId:e.pageId,kind:f})};return this.addEventListener("loadend",()=>p()),this.addEventListener("timeout",()=>p("timeout")),this.addEventListener("abort",()=>p("abort")),this.addEventListener("error",()=>p("error")),o.call(this,s)},X=()=>{t.prototype.open=r,t.prototype.send=o,t.prototype.setRequestHeader=a}}},teardown(){q?.(),q=void 0,X?.(),X=void 0}};function He(e,n){let t="",r="GET";return typeof e=="string"||e instanceof URL?(t=e.toString(),r=(n?.method||"GET").toUpperCase()):(t=e.url,r=(e.method||n?.method||"GET").toUpperCase()),{url:t,method:r}}function De(e,n){let t=new Headers,r=o=>{if(o){if(o instanceof Headers){o.forEach((a,s)=>t.set(s,a));return}if(Array.isArray(o)){o.forEach(([a,s])=>t.set(a,s));return}Object.entries(o).forEach(([a,s])=>t.set(a,String(s)))}};return r(e),r(n),t}function Se(e,n){if(!e)return!1;if(!n||n.size===0)return!0;try{let t=new URL(e,location.href).host;for(let r of n)if(t.includes(r))return!0;return!1}catch{return!1}}function z(e,n){try{let t=new URL(e,location.href);if(n&&n.size>0){let r=new URLSearchParams;t.searchParams.forEach((o,a)=>{n.has(a)&&r.set(a,o)}),t.search=r.toString()}else t.search="";return t.hash="",t.toString()}catch{return String(e||"")}}function Pe(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}function v(){try{return performance.now()}catch{return Date.now()}}var $,G,j,k,_,R,w,I,K={name:"perf",setup(e,n){n.track({type:"__plugin_loaded",plugin:"perf"});let t=()=>{try{let a=performance.getEntriesByType("navigation")[0];a&&(n.track({type:"ttfb",value:a.responseStart-a.requestStart,pageId:e.pageId}),n.track({type:"nav",pageId:e.pageId,domInteractive:a.domInteractive,dcl:a.domContentLoadedEventEnd-a.startTime,load:a.loadEventEnd-a.startTime})),performance.getEntriesByType("paint").forEach(s=>{(s?.name==="first-paint"||s?.name==="first-contentful-paint")&&n.track({type:s.name,value:s.startTime,pageId:e.pageId})})}catch{}};document.readyState==="complete"&&t(),addEventListener("load",t),j=()=>removeEventListener("load",t);try{_=new PerformanceObserver(a=>{for(let s of a.getEntries())s.duration>=50&&n.track({type:"longtask",value:s.duration,pageId:e.pageId})}),L(_,"longtask",!0)}catch{}let r=!1;try{import("web-vitals/attribution").then(({onLCP:a,onCLS:s,onINP:u})=>{r=!0,a(i=>n.track({type:"lcp",value:i.value,pageId:e.pageId})),s(i=>n.track({type:"cls",value:i.value,pageId:e.pageId})),u(i=>n.track({type:"inp",value:i.value,pageId:e.pageId}))}).catch(()=>J(e,n))}catch{J(e,n)}setTimeout(()=>{r||J(e,n)},1e3),k=window.setTimeout(()=>{try{let a=document.body?document.body.querySelectorAll("*").length:0;a<50&&n.track({type:"whitescreen",nodes:a,pageId:e.pageId})}catch{}},3e3);try{let a=navigator.connection||navigator.mozConnection||navigator.webkitConnection;a&&n.track({type:"netinfo",effectiveType:String(a.effectiveType||""),rtt:Number(a.rtt||0),downlink:Number(a.downlink||0),saveData:!!a.saveData,pageId:e.pageId})}catch{}let o=Fe(()=>{Y(n,e)});$=()=>document.removeEventListener("visibilitychange",o,!0),G=()=>removeEventListener("pagehide",o,!0)},teardown(){try{_?.disconnect()}catch{}try{R?.disconnect()}catch{}try{w?.disconnect()}catch{}try{I?.disconnect()}catch{}_=R=w=I=void 0,$?.(),G?.(),$=G=void 0,j?.(),j=void 0,k&&(clearTimeout(k),k=void 0)}},be=!1,B=0,T=0,V=0,Ee=!1;function J(e,n){if(be)return;be=!0;try{R=new PerformanceObserver(r=>{let o=r.getEntries(),a=o[o.length-1];a&&(B=a.startTime)}),L(R,"largest-contentful-paint",!0)}catch{}try{T=0,w=new PerformanceObserver(r=>{for(let o of r.getEntries())o.hadRecentInput||(T+=o.value)}),L(w,"layout-shift",!0)}catch{}try{I=new PerformanceObserver(r=>{for(let o of r.getEntries()){let a=Math.max(0,o.processingStart-o.startTime);a&&(V=a)}}),L(I,"first-input",!0)}catch{}let t=()=>{if(!Ee){Ee=!0;try{R?.disconnect()}catch{}try{w?.disconnect()}catch{}try{I?.disconnect()}catch{}B&&n.track({type:"lcp",value:B,pageId:e.pageId}),T&&n.track({type:"cls",value:Number(T.toFixed(4)),pageId:e.pageId}),V&&n.track({type:"fid",value:V,pageId:e.pageId})}};Y._=t}function Y(e,n){let t=Y._;t&&t()}function L(e,n,t=!1){if(e)try{e.observe({type:n,buffered:t})}catch{try{e.observe({entryTypes:[n]})}catch{}}}function Fe(e){let n=!1,t=()=>{n||document.visibilityState==="hidden"&&(n=!0,e())};return document.addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,{capture:!0,once:!0}),t}var Q,Z,ee,te,ne,ae={name:"route",setup(e,n){n.track({type:"__plugin_loaded",plugin:"route"});let t=re(location.href,e.allowParams,!0),r=A(),o=!1;n.track({type:"pv",url:t,referrer:re(document.referrer||"",e.allowParams,!0),title:ke(),pageId:e.pageId});let a=history.pushState,s=history.replaceState;history.pushState=function(d,p,f){let g=a.call(this,d,p,f);return c(f??location.href),g},history.replaceState=function(d,p,f){let g=s.call(this,d,p,f);return c(f??location.href),g},Q=()=>{history.pushState=a},Z=()=>{history.replaceState=s};let u=()=>c(location.href),i=()=>c(location.href);addEventListener("popstate",u),addEventListener("hashchange",i),ee=()=>removeEventListener("popstate",u),te=()=>removeEventListener("hashchange",i);let l=()=>{o||document.visibilityState==="hidden"&&(o=!0,n.track({type:"route-leave",url:t,dur:A()-r,reason:"hidden",pageId:e.pageId}))};document.addEventListener("visibilitychange",l,!0),addEventListener("pagehide",l,{capture:!0,once:!0}),ne=()=>{document.removeEventListener("visibilitychange",l,!0),removeEventListener("pagehide",l,!0)};function c(d){let p=re(String(d??location.href),e.allowParams,!0);if(!p||p===t)return;n.track({type:"route-leave",url:t,dur:A()-r,pageId:e.pageId}),Re(e);let f=t;t=p,r=A(),o=!1,n.track({type:"pv",url:t,referrer:f,title:ke(),pageId:e.pageId})}},teardown(){try{Q?.()}catch{}try{Z?.()}catch{}try{ee?.()}catch{}try{te?.()}catch{}try{ne?.()}catch{}Q=Z=ee=te=ne=void 0}};function re(e,n,t=!0){if(!e)return"";try{let r=new URL(e,location.href);if(n&&n.size>0){let o=new URLSearchParams;r.searchParams.forEach((a,s)=>{n.has(s)&&o.set(s,a)}),r.search=o.toString()}else r.search="";return t||(r.hash=""),r.toString()}catch{return String(e||"")}}function A(){try{return performance.now()}catch{return Date.now()}}function ke(){try{return String(document.title||"").slice(0,200)}catch{return""}}var oe,se={name:"console",setup(e,n){let t={log:console.log,info:console.info,warn:console.warn,error:console.error},r=o=>(...a)=>{try{let s=a.map(u=>Ne(u)).join(" ");(o==="error"||o==="warn")&&n.track({type:"console",level:o,message:s.slice(0,1e3),pageId:e.pageId})}catch{}t[o].apply(console,a)};console.log=r("log"),console.info=r("info"),console.warn=r("warn"),console.error=r("error"),oe=()=>{console.log=t.log,console.info=t.info,console.warn=t.warn,console.error=t.error}},teardown(){oe?.(),oe=void 0}};function Ne(e){try{return typeof e=="string"?e:e?.stack||e?.message?String(e.stack||e.message):JSON.stringify(e)}catch{return String(e)}}var C,ie={name:"resource",setup(e,n){try{C=new PerformanceObserver(t=>{for(let r of t.getEntries())Xe(e.allowDomains,r.name)&&n.track({type:"res",name:ze(r.name,e.allowParams,!1),initiator:r.initiatorType,dur:r.duration,ttfb:r.responseStart-r.requestStart,transfer:r.transferSize,encoded:r.encodedBodySize,decoded:r.decodedBodySize,fromCache:r.transferSize===0&&(r.encodedBodySize>0||r.decodedBodySize>0),pageId:e.pageId})}),qe(C,"resource",!0)}catch{}},teardown(){try{C?.disconnect()}catch{}C=void 0}};function qe(e,n,t=!1){if(e)try{e.observe({type:n,buffered:t})}catch{try{e.observe({entryTypes:[n]})}catch{}}}function Xe(e,n){if(!e||e.size===0)return!0;try{let t=new URL(n).host;return[...e].some(r=>t.includes(r))}catch{return!1}}function ze(e,n,t=!0){try{let r=new URL(e,location.href);if(n?.size){let o=new URLSearchParams;r.searchParams.forEach((a,s)=>n.has(s)&&o.set(s,a)),r.search=o.toString()}else r.search="";return t||(r.hash=""),r.toString()}catch{return e}}var ce,ue,le={name:"behavior",setup(e,n){let t=Math.random()<.1,r=[],o=i=>{if(t){let c=i.target;n.track({type:"click",x:i.clientX,y:i.clientY,tag:c?.tagName,id:c?.id,cls:c?.className?.toString()?.slice(0,80),pageId:e.pageId})}let l=Date.now();r=r.filter(c=>l-c<1500).concat(l),r.length>=3&&(n.track({type:"rage-click",x:i.clientX,y:i.clientY,pageId:e.pageId}),r.length=0)},a=()=>{let i=document.documentElement,l=Math.max(1,i.scrollHeight-i.clientHeight),c=Math.round(i.scrollTop/l*100);n.track({type:"scroll-depth",value:c,pageId:e.pageId})};addEventListener("click",o,!0);let s,u=()=>{clearTimeout(s),s=window.setTimeout(a,400)};addEventListener("scroll",u,{passive:!0}),ce=()=>removeEventListener("click",o,!0),ue=()=>removeEventListener("scroll",u)},teardown(){ce?.(),ue?.(),ce=ue=void 0}};var M,_e=[],de={name:"exposure",setup(e,n){if(!_e.length)return;let t=new Set;M=new IntersectionObserver(r=>{r.forEach(o=>{if(o.isIntersecting){let a=o.target.__rumExpId;a&&!t.has(a)&&(t.add(a),n.track({type:"exposure",id:a,ratio:o.intersectionRatio,pageId:e.pageId}))}})},{threshold:[0,.25,.5,.75,1]});for(let r of _e)document.querySelectorAll(r.selector).forEach(o=>{o.__rumExpId=r.id,M.observe(o)})},teardown(){try{M?.disconnect()}catch{}M=void 0}};var pe,fe,ge={name:"lifecycle",setup(e,n){let t=o=>{o.persisted&&n.track({type:"bfcache-restore",pageId:e.pageId})},r=()=>n.track({type:"visibility",state:document.visibilityState,pageId:e.pageId});addEventListener("pageshow",t),document.addEventListener("visibilitychange",r,!0),pe=()=>removeEventListener("pageshow",t),fe=()=>document.removeEventListener("visibilitychange",r,!0)},teardown(){pe?.(),fe?.(),pe=fe=void 0}};var S,me,ye={name:"ws",setup(e,n){let t=window.WebSocket;t&&(S=t,window.WebSocket=function(r,o){let a=o?new S(r,o):new S(r),s=Date.now(),u=String(r);return n.track({type:"ws-open",url:u,pageId:e.pageId}),a.addEventListener("open",i=>{n.track({type:"ws-ready",url:u,ttfb:Date.now()-s,pageId:e.pageId})}),a.addEventListener("error",i=>{n.track({type:"ws-error",url:u,pageId:e.pageId})}),a.addEventListener("close",i=>{n.track({type:"ws-close",url:u,code:i.code,wasClean:i.wasClean,pageId:e.pageId})}),a},window.WebSocket.prototype=S.prototype,me=()=>{window.WebSocket=S})},teardown(){me?.(),me=void 0}};function wt(e){if(!e?.appId||!e?.release)throw new Error("[RUM] appId & release required");let n=ve(e),t=we({endpoint:e.endpoint,appId:e.appId,release:e.release}),r=he(),o=e.features??{},a=(c,d)=>o[c]===void 0?d:!!o[c];a("error",!0)&&r.use(N),a("net",!0)&&r.use(W),a("perf",!0)&&r.use(K),a("route",!0)&&r.use(ae),a("console",!1)&&r.use(se),a("resource",!1)&&r.use(ie),a("behavior",!1)&&r.use(le),a("exposure",!1)&&r.use(de),a("lifecycle",!1)&&r.use(ge),a("ws",!1)&&r.use(ye),r.setupAll(n,t);let s=()=>t.flush(!0),u=()=>{document.visibilityState==="hidden"&&t.flush(!0)};addEventListener("pagehide",s),addEventListener("visibilitychange",u);let i=c=>t.__subscribe(c);try{window.__RUM_TAP__=i}catch{}return{version:U,track:t.track,flush:t.flush,setUserId(c){n.uid=c},setTags(c){n.tags={...n.tags,...c}},onEvent:i,destroy(){try{removeEventListener("pagehide",s)}catch{}try{removeEventListener("visibilitychange",u)}catch{}try{r.teardownAll()}catch{}try{t.flush(!0)}catch{}}}}var It=U;export{wt as initRUM,It as version};
